# config.yaml — Engineering Metrics Dashboard Configuration
# This is the single source of truth for all team/project/repo mappings.

# ============================================================
# Service Connections
# ============================================================
jira:
  base_url: "https://kkday.atlassian.net"
  # Auth via env vars: JIRA_EMAIL, JIRA_API_TOKEN

github:
  org: "kkday-it"
  # Auth via env var: GITHUB_TOKEN

jenkins:
  base_url: "https://jenkins.kkday.com"
  # Auth via env vars: JENKINS_USER, JENKINS_API_TOKEN
  enabled: false  # Jenkins 在內網，CI 無法存取

# ============================================================
# Jira Status → Phase Mapping
# ============================================================
# Phases represent the value stream stages.
# Map your Jira statuses to these phases.
# Use "default" for the common mapping, "overrides" for per-project exceptions.

phases:
  - id: backlog
    label: "Backlog"
    description: "Not yet being worked on"
    color: "#94a3b8"
  - id: planning
    label: "SA/SD"
    description: "System analysis and design"
    color: "#a78bfa"
  - id: dev
    label: "Development"
    description: "Active coding"
    color: "#60a5fa"
  - id: review
    label: "PR Review"
    description: "Code review in progress"
    color: "#34d399"
  - id: dev_test
    label: "RD Testing"
    description: "Developer-side testing"
    color: "#fbbf24"
  - id: qa
    label: "QA Testing"
    description: "QA team testing"
    color: "#f97316"
  - id: staging
    label: "Staging"
    description: "Stage environment / regression"
    color: "#f472b6"
  - id: done
    label: "Done"
    description: "Released to production"
    color: "#22c55e"

status_mapping:
  default:
    backlog:
      - "To Do"
      - "TODO"
      - "New Request"
      - "Backlog"
      - "Pending"
      - "Pending 項目擱置"
      - "Evaluate"
      - "Open"
      - "待處理"
      - "Awaiting"
    planning:
      - "Analysis"
      - "SA/SD"
      - "In Analysis"
      - "Design"
      - "Planning"
      - "System Design"
      - "PM/AM Confirmation"
      - "PM/AM SURVEY"
      - "規劃中"
      - "需求分析"
      - "Requirement Review"
    dev:
      - "In Progress"
      - "In Process"
      - "In Development"
      - "Developing"
      - "Coding"
      - "開發中"
    review:
      - "In Review"
      - "Code Review"
      - "PR Review"
      - "PR Merged"
      - "Peer Review"
      - "審查中"
    dev_test:
      - "Dev Testing"
      - "Dev Test"
      - "RD Testing"
      - "RD Test"
      - "開發測試"
      - "RD 測試中"
    qa:
      - "QA"
      - "QA Testing"
      - "In QA"
      - "Waiting for QA"
      - "FEATURE TESTING"
      - "PM/QA REVIEW"
      - "Quality Assurance"
      - "QA 測試中"
    staging:
      - "Staging"
      - "Waiting for Stage"
      - "Waiting for Release"
      - "Wait For Release"
      - "Regression"
      - "UAT"
      - "Stage"
      - "Pre-Production"
      - "Stage 環境"
    done:
      - "Done"
      - "Released"
      - "Closed"
      - "Resolved"
      - "OBSERVE"
      - "已完成"
      - "已上線"

  # Per-project overrides — only specify the differences
  overrides: {}
  #  PROJ-A:
  #    planning:
  #      - "Requirement Review"
  #      - "Architecture Design"

# ============================================================
# SA/SD 獨立票識別規則
# ============================================================
# 符合規則的票會被排除在主 cycle time / throughput / bottleneck 之外，
# 其活躍時間（排除 backlog/done/unmapped）會合併到 planning phase 數據點。
#
# issue_types：精確匹配 Jira issue type（不是 regex）
# summary_patterns：regex，case-insensitive，匹配票名（summary）
# overrides：per-team 完全取代全域規則（與 status_mapping.overrides 語義一致）

sa_sd_rules:
  issue_types:
    - "SA/SD"
  summary_patterns:
    - "^\\[SA\\]"
    - "^\\[SD\\]"
    - "(?<![A-Za-z])SA/?SD(?![A-Za-z])"
  overrides: {}
  #  team-scm:
  #    issue_types: ["Analysis"]
  #    summary_patterns: ["^\\[需求分析\\]"]

# ============================================================
# Teams
# ============================================================
teams:
  - name: "Team product"
    id: "team-product"
    jira_projects:
      - "BE2PROD"
    github_repos:
      - "kkday-product-service"
      - "kkday-be2-web"
      - "katalyst"
      - "kkday-psi-service"
      - "kkday-pos-api"
      - "kkday-psi-web"
      - "kkday-pos-web"
      - "kkday-commission-service"
      - "kkday-be2-product"
      - "kkday-be2-commission"
      - "kkday-detective"
      - "kkday-be2-detective"
      - "kkday-product-external-api"
    jenkins_jobs:
      - "deploy-asg-kkday-api-commission"
      - "deploy-asg-kkday-api-detective"
      - "deploy-asg-kkday-api-product"
      - "deploy-asg-kkday-be2-commission"
      - "deploy-asg-kkday-be2-detective"
      - "deploy-asg-kkday-be2-navigation"
      - "deploy-asg-kkday-be2-product"
      - "deploy-asg-kkday-be2-web"
      - "deploy-asg-kkday-katalyst"
      - "deploy-asg-kkday-pos-api"

  - name: "Team b2b"
    id: "team-b2b"
    jira_projects:
      - "ROB"
    github_repos:
      - "kkday-robot-order-api"
      - "kkday-booking-robot"
      - "kkday-be2-b2b"
      - "kkday-psp"
      - "kkday-booking-robot-for-windows"
      - "kkday-b2b-api"
    jenkins_jobs:
      - "deploy-asg-kkday-b2b-api"
      - "deploy-asg-kkday-be2-b2b"
      - "deploy-asg-kkday-booking-robot"
      - "deploy-asg-kkday-api-robot-order"
      - "deploy-asg-kkday-rbms"
      - "deploy-asg-kkday-b2s-api"
      - "deploy-asg-kkday-b2s-bsm"
      - "deploy-asg-kkday-kmag-api"

  - name: "Team scm"
    id: "team-scm"
    jira_projects:
      - "SCMWEB"
    github_repos:
      - "kkday-supplier-web"
      - "kkday-supplier-api"
      - "kkday-scm-backend"
      - "kkday-scm-frontend"
    jenkins_jobs:
      - "deploy-asg-kkday-scm-web"
      - "deploy-asg-kkday-supplier-api"
      - "deploy-asg-kkday-scm-api"
      - "deploy-asg-kkday-scm-frontend"

  # TODO: Add remaining 16 teams
  # Tip: You can generate this section from a spreadsheet or script

# ============================================================
# Collection Settings
# ============================================================
collection:
  lookback_days: 180
  recent_days: 30
  jira_jql_filter: "issuetype in (Story, Bug, Task, Sub-task)"
  pr_issue_pattern: "([A-Z][A-Z0-9]+-\\d+)"
  api_delay_seconds: 0.5              # Delay between Jira search API calls (between pages/projects)
  jira_changelog_api_delay_seconds: 0.1  # Delay between per-issue changelog API calls
  incremental_overlap_hours: 25       # 增量模式：只收集最近 N 小時有更新的 issue（25h > 24h 確保不漏）
  github_api_delay_seconds: 0.1       # Delay between GitHub API calls (5000 req/hr allows ~1.4/sec)
  max_concurrent_requests: 5

# ============================================================
# Dashboard Settings
# ============================================================
dashboard:
  # Thresholds for heatmap colors (in days)
  cycle_time_thresholds:
    good: 2.0      # Below this → green
    warning: 5.0   # Below this → yellow, above → red
  pr_pickup_thresholds:
    good: 4.0      # Hours
    warning: 12.0
  large_pr_threshold: 400  # Lines changed

